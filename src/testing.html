<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <title>Shopify and OpenAI API Testing</title>
  </head>
  <body>
    <h2>Shopify Session and OpenAI API Testing</h2>

    <button id="store-session">Store Session</button>

    <h2>Create User</h2>
    <button id="create-user">Create Complete Dummy User</button>

    <h2>OpenAI API Testing</h2>
    <input type="text" id="openai-prompt" placeholder="Enter your prompt" />
    <button id="send-prompt">Send Prompt</button>
    <h2>Fetch Conversations</h2>
    <button id="fetch-conversations">Fetch Conversations</button>
    <h2>Fetch Metrics</h2>
    <button id="fetch-metrics">Fetch Metrics</button>

<h2>Test Authentication</h2>
<button id="test-authenticate">Test Authenticate</button>


     <h2>Fetch User by Email</h2>
    <input type="email" id="user-email" placeholder="Enter user email" />
    <button id="fetch-user">Fetch User Details</button>

    <div id="output"></div> <!-- For displaying messages -->

    <script>
      const socket = io('http://localhost:3000', {
        withCredentials: true,
        transports: ['websocket'],
      });

      function logMessage(message) {
        const output = document.getElementById('output');
        const newMessage = document.createElement('p');
        newMessage.textContent = message;
        output.appendChild(newMessage);
      }

      socket.on('connect', () => {
        logMessage('Connected to the server with Socket ID: ' + socket.id);
      });

      socket.on('connect_error', (error) => {
        logMessage('Connection Error: ' + error);
      });

      // Create Complete Dummy User Button
      document.getElementById('create-user').addEventListener('click', () => {
        const dummyUser = {
          userId: '64cae7843f3d2e4f1f3d7b55', // Example ObjectId
          firstName: 'John',
          lastName: 'Doe',
          email: 'john.doe@example.com',
          phoneNumber: '1234567890',
          address: {
            street: '123 Main St',
            city: 'Anytown',
            state: 'CA',
            postalCode: '12345',
            country: 'USA',
          },
          pastOrders: [
            {
              orderId: '64cae7843f3d2e4f1f3d7b57', // Example ObjectId
              totalAmount: 199.99,
              orderStatus: 'Completed',
              createdAt: new Date('2023-10-20T14:48:00'),
              updatedAt: new Date('2023-10-21T10:30:00'),
            },
          ],
          favorites: [
            {
              productId: 101,
              title: 'Sample Product',
              price: 49.99,
            },
          ],
          createdAt: new Date(),
          updatedAt: new Date(),
        };

        logMessage('Creating user: ' + JSON.stringify(dummyUser));
        socket.emit('createUser', dummyUser);

        socket.on('userCreated', (response) => {
          if (response.success) {
            logMessage('User created successfully with ID: ' + response.userId);
          } else {
            logMessage('User creation failed: ' + response.error);
          }
        });
      });
  
      document.getElementById('test-authenticate').addEventListener('click', () => {
      const dummyAuthData = {
    userId: '95cae7843f3d2e4f1f3d7b56', // Example ObjectId
    email: 'john1.doe@example.com',
    // Add any other fields you want to include for authentication
  };
  
  logMessage('Testing authentication with data: ' + JSON.stringify(dummyAuthData));
  socket.emit('authenticate', dummyAuthData);
});

// Listen for authentication response
socket.on('authenticated', (response) => {
  if (response.success) {
    logMessage('Authentication successful');
  } else {
    logMessage('Authentication failed: ' + response.error);
  }
});

socket.on('sessionExpired', () => {
  logMessage('Session expired. Reloading page...');
  clearSessionData();
  setTimeout(() => {
    window.location.reload();
  }, 2000);
});

       document.getElementById('fetch-user').addEventListener('click', () => {
        const email = document.getElementById('user-email').value.trim();
        if (!email) {
          logMessage('Please enter a valid email address.');
          return;
        }

        logMessage('Fetching user details for: ' + email);
        socket.emit('getUserByEmail', email);

        socket.on('userDetails', (response) => {
          if (response.success) {
            logMessage('User Details: ' + JSON.stringify(response.user));
          } else {
            logMessage('Error: ' + (response.message || response.error));
          }
        });
      });
      // Store Session Button
      document.getElementById('store-session').addEventListener('click', () => {
        logMessage('Checking if server is alive...');
        socket.emit('pingServer');

        socket.on('pongServer', async (data) => {
          logMessage('Server response: ' + data.message);
          logMessage('Storing session...');

          const dummySession = {
            id: 'sk-test-store1.myshopify.com_75885969541',
            shop: 'sk-test-store1.myshopify.com',
            state: '706656270562885',
            isOnline: true,
            scope: 'write_orders,read_product_listings,write_products',
            expires: '2024-10-26T17:42:46.787Z',
            accessToken: 'shpua_67a19b6bec3c269193abc7df6cf7a6d5',
            onlineAccessInfo: {
              expires_in: 86399,
              associated_user_scope: 'write_orders,read_product_listings,write_products',
              associated_user: {
                id: 75885969541,
                first_name: 'surya',
                last_name: 'kangeyan',
                email: 'suryakangeyan4701@gmail.com',
                account_owner: true,
                locale: 'en',
                collaborator: false,
                email_verified: true,
              },
            },
          };

          socket.emit('storeSession', dummySession);
          await new Promise((resolve) => setTimeout(resolve, 1000));
          socket.emit('fetchAndStoreAllProducts');

          socket.on('sessionStored', (data) => {
            logMessage('Session Stored: ' + data.message);
          });

          socket.on('error', (error) => {
            logMessage('Error storing session: ' + error);
          });
        });
      });

      // Send OpenAI Prompt Button
      document.getElementById('send-prompt').addEventListener('click', () => {
        const prompt = document.getElementById('openai-prompt').value;
        logMessage('Sending prompt to OpenAI: ' + prompt);

        socket.emit('openaiPrompt', { prompt });

        socket.on('openaiResponse', (data) => {
          logMessage('OpenAI Response: ' + data.result);
        });

        socket.on('openaiError', (error) => {
          logMessage('Error from OpenAI: ' + error);
        });
      });

      document.getElementById('fetch-metrics').addEventListener('click', () => {
        socket.emit('fetchMetrics');

        socket.on('metrics', (data) => {
          if (data.success) {
            logMessage('Metrics fetched successfully: ' + JSON.stringify(data.metrics));
          } else {
            logMessage('Error fetching metrics: ' + data.error);
          }
        });

        socket.on('error', (error) => {
          logMessage('Error fetching metrics: ' + error);
        });
      });


      // Query Products Button
      // document.getElementById('query-products').addEventListener('click', () => {
      //   const productQuery = document.getElementById('product-query').value;
      //   logMessage('Querying products: ' + productQuery);

      //   socket.emit('queryProducts', {productQuery });

      //   socket.on('queryResults', (data) => {
      //     logMessage('Query Results: ' + data.message);
      //   });

      //   socket.on('error', (error) => {
      //     logMessage('Error querying products: ' + error);
      //   });
      // });

      // Add Fetch Conversations Button event listener
      document.getElementById('fetch-conversations').addEventListener('click', () => {
        const userId = '671db06569ef6ff3df65823d'; 
        logMessage('Fetching conversations for userId: ' + userId);
        
        socket.emit('fetchConversations', userId); 
        
        socket.on('conversationsData', (data) => {
          if (data.success) {
            logMessage('Conversations fetched successfully.');
            data.conversations.forEach(conversation => {
              // logMessage(`Conversation ID brotha: ${conversation._id}`);
              logMessage(`first user message!!! ${data.conversations[0].messages[0].userMessage}`)
              conversation.messages.forEach(message => {
                logMessage(`User: ${message.userInput.content} at ${message.userInput.timestamp}`);
                
                const llmOutput = JSON.parse(message.llmOutput.content);
                logMessage(`AI Response: ${llmOutput.message}`);
                
                // Log recommendations if they exist
                if (llmOutput.recommendations && Array.isArray(llmOutput.recommendations)) {
                  llmOutput.recommendations.forEach(recommendation => {
                    logMessage(`Recommendation: ${recommendation.title} - ${recommendation.description}`);
                  });
                }
              });
            });
          } else {
            logMessage('No conversations found.');
          }
        });

        socket.on('error', (error) => {
          logMessage('Error fetching conversations: ' + error);
        });
      });
      //////
      socket.on('disconnect', () => {
        logMessage('Disconnected from the server.');
      });
    </script>
  </body>
</html>
